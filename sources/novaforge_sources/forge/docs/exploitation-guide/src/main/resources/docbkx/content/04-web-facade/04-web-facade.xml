<?xml version="1.0" encoding="UTF-8"?>
<!--
 * Copyright (c) 2011-2015, BULL SAS, NovaForge Version 3 and above.
 *
 * This file is free software: you may redistribute and/or 
 * modify it under the terms of the GNU Affero General Public License
 * as published by the Free Software Foundation, version 3 of the License.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty
 * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Affero General Public License for more details.
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see http://www.gnu.org/licenses.
 *
 * Additional permission under GNU AGPL version 3 (AGPL-3.0) section 7
 *
 * If you modify this Program, or any covered work,
 * by linking or combining it with libraries listed
 * in COPYRIGHT file at the top-level directof of this
 * distribution (or a modified version of that libraries),
 * containing parts covered by the terms of licenses cited
 * in the COPYRIGHT file, the licensors of this Program
 * grant you additional permission to convey the resulting work.
-->
<chapter version="5.0" xml:lang="fr" xmlns="http://docbook.org/ns/docbook"
	xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:ns5="http://www.w3.org/2000/svg" xmlns:ns4="http://www.w3.org/1998/Math/MathML"
	xmlns:ns3="http://www.w3.org/1999/xhtml" xmlns:db="http://docbook.org/ns/docbook">
	<title>Facade Web</title>

	<sect2>
		<title>Apache</title>
		<sect3>
			<title>Description</title>
			<para>
				Plusieurs modules sont présents et utilisés par des produits PHP (se
				référer au document d'architecture pour une liste exhaustive).
				NovaForge est configuré par défaut avec un accès sécurisé
				https
				(configuration SSL).
				Le fichier de configuration principal
				<emphasis>httpd.conf</emphasis>
				se situe dans :
			</para>
			<programlisting language="shell"># /etc/httpd/conf/httpd.conf</programlisting>

			<para>
				Le fichier de configuration dédié à l'application NovaForgeV3
				<emphasis>novaforge.conf</emphasis>
				se situe dans :
			</para>
			<programlisting language="shell"># $NOVA_HOME/system/httpd/conf.d/novaforge.conf</programlisting>

			<para>
				Dans le répertoire
				<emphasis>$NOVA_HOME/system/httpd/conf.d/</emphasis>
				on trouve également 3 dossiers contenant des configurations
				spécifiques :
			</para>
			<itemizedlist>
				<listitem>
					<para>
						<emphasis role="bold">modules</emphasis>
						: contient le chargement de modules spécifiques notamment pour SSL et SVN.
					</para>
				</listitem>
				<listitem>
					<para>
						<emphasis role="bold">services</emphasis>
						: contient les directives génériques (Alias, ProxyPass, Location) propres à chaque outil.
					</para>
				</listitem>
			</itemizedlist>
		</sect3>
		<sect3>
			<title>Arrêt/Relance</title>
			<para>Un service permet d'arrêter/relancer tous les processus httpd.
			</para>
			<programlisting language="shell"># systemctl start httpd
# systemctl stop httpd</programlisting>
		</sect3>
		<sect3>
			<title>Fichiers de logs</title>
			<para>Les fichiers de journalisation se trouvent dans : </para>
			<programlisting language="shell"># $NOVA_HOME/logs/httpd</programlisting>
		</sect3>

		<sect3>
			<title>Génération du certificat SSL</title>
			<para>L'activation SSL nécessite la création de certificats SSL et l'import de ce certificat dans le keystore java des différentes machines de la Forge.</para>

			<para>
				<inlinemediaobject>
					<imageobject>
						<imagedata fileref="02-dialog-warning.png" width="27px" />
					</imageobject>
				</inlinemediaobject>
				Attention, le certificat est généré par défaut lors de
				l'installation avec une date d'expiration de 365 jours à compter de la date d'installation.
			</para>

			<para>
				Avant l'expiration de ce certificat, en regénérer un nouveau sur le <emphasis>portail</emphasis> en remplacant le keystore <emphasis>/datas/novaforge3/system/crt/novaforge.p12</emphasis> et en extraire la clef et le certificat (respectivement <emphasis>/datas/novaforge3/system/crt/novaforge.key</emphasis> et  <emphasis>/datas/novaforge3/system/crt/novaforge.crt</emphasis>).

				Le keystore <emphasis>novaforge.p12</emphasis> doit ensuite être ajouté dans le keystore java de l'ensemble des machines de la forge.
			</para>
			<programlisting># NOVA_HOME=/datas/novaforge3
# SSL_P12_NAME=`hostname`
# $NOVA_HOME/engines/jre/bin/keytool -importkeystore
-deststorepass novaforge_1
-destkeypass novaforge_1 -destkeystore $NOVA_HOME/system/crt/novaforge.jks 
-srckeystore $NOVA_HOME/system/crt/novaforge.p12 -srcstoretype PKCS12 
-srcstorepass N0V4FoRG3_1 -alias ${SSL_P12_NAME}</programlisting>

		</sect3>

		<sect3>
			<title>Filtrage IP Apache</title>
				<para>Pour autoriser l'accès à la facade web à quelques utilisateurs
					un filtre IP peut être mis en place via le fichier de configuration
					apache.
				</para>

				<para>
					Editer le fichier
					<emphasis>novaforge.conf</emphasis>
					:
				</para>

				<programlisting language="shell"># vi $NOVA_HOME/system/httpd/conf.d/novaforge.conf</programlisting>

				<para>
					Editer les configurations du proxy en remplaçant <emphasis>"Allow from all"</emphasis>"
				</para>

				<programlisting language="shell">
&lt;Proxy *&gt;
	AddDefaultCharset On
	Order Deny,Allow
	Deny from all
	Allow from xxx.xxx.xxx.xxx # IP of the local machine
	Allow from yyy.yyy.yyy.yyy # IP of any deported tool
	Allow from zzz.zzz.zzz.zzz # IP of any user
&lt;/Proxy&gt;
				</programlisting>

				<para>Recharger la nouvelle configuration Apache</para>
				<programlisting language="shell"># systemctl reload httpd</programlisting>

				<para>
					<inlinemediaobject>
						<imageobject>
							<imagedata fileref="02-dialog-warning.png" width="27px" />
						</imageobject>
					</inlinemediaobject>
					Attention à l'utilisation d'un proxy entre l'utilisateur et la
					forge
				</para>
		</sect3>
		<sect3>
			<title>Erreur Apache 403 et 404 personnalisées</title>

				<para>Les pages d'erreurs 403 et 404 sont personnalisables via le
					fichier de configuration Apache. Pour rediriger les erreurs vers
					une page HTML, dans le fichier novaforge.conf, ajouter la directive
					suivante :
				</para>
				<programlisting language="shell">ErrorDocument 403
/errors/403.html</programlisting>

				<para>Créer la page d'erreur</para>
				<programlisting language="shell"># mkdir $NOVA_HOME/system/httpd/errors
# echo "Error 403" >> $NOVA_HOME/system/httpd/errors/403.html</programlisting> 

				<para>Créer un alias au répertoire d'erreur :</para>
				<programlisting language="shell"># touch $NOVA_HOME/system/httpd/conf.d/services/publics/errors.service
# vi $NOVA_HOME/system/httpd/conf.d/services/publics/errors.service</programlisting> 
				
				<para>Compléter le fichier créé :</para>
				<programlisting language="shell">Alias /errors/ "<![CDATA[<NOVA_HOME>]]>system/httpd/errors/"

&lt;Directory <![CDATA[<NOVA_HOME>]]>/system/httpd/errors&gt;
   				Options Indexes
   				Order Allow,Deny
   				Allow from all
&lt;/Directory&gt;</programlisting>
				
				<para>Recharger la nouvelle configuration Apache</para>
				<programlisting language="shell">#/etc/init.d/httpd reload</programlisting>
		</sect3>

		<sect3>
			<title>Moteur PHP</title>
			<para>
				PHP en version 5.4.16 est utilisé par le serveur web afin de gérer les pages dynamiques.
				Le fichier <emphasis>php.ini</emphasis> contenant sa configuration est installé dans le répertoire suivant :
			</para>
			<programlisting language="shell"># /etc/php.ini</programlisting>
			<para>
				<inlinemediaobject>
					<imageobject>
						<imagedata fileref="02-dialog-warning.png" width="27px" />
					</imageobject>
				</inlinemediaobject>
				Attention, le dossier
				<emphasis>$NOVA_HOME/system/php</emphasis>
				est vide !
			</para>
			<sect3>
				<title>Arrêt/Relance</title>
				<para>L'arrêt ou le lancement de PHP est entièrement lié au cycle de
					vie du serveur Web Apache décrit précédemment.
				</para>
			</sect3>
			<sect3>
				<title>Fichiers de logs</title>
				<para>Les enregistrements de journaux associés à PHP sont
					potentiellement liés soit au serveur web vu précédemment soit liés
					à chaque produit. Voir les sections appropriées pour obtenir plus
					d'informations.
				</para>
			</sect3>
			<sect3>
				<title>Stockage des sessions PHP</title>
				<para>
					Par défaut, toutes les données relatives à une session
					particulière
					seront stockées dans un fichier du répertoire spécifié
					par
					session.save_path dans les options du fichier php.ini. Un
					fichier
					pour chaque session sera créé.
					Le dossier de stockage des
					sessions PHP est :
				</para>
				<programlisting language="shell"># $NOVA_HOME/datas/php/session</programlisting>
			</sect3>
		</sect3>
	</sect2>
</chapter>
