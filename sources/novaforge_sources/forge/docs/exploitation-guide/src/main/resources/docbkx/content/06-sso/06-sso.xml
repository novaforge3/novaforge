<?xml version="1.0" encoding="UTF-8"?>
<!--
 * Copyright (c) 2011-2015, BULL SAS, NovaForge Version 3 and above.
 *
 * This file is free software: you may redistribute and/or 
 * modify it under the terms of the GNU Affero General Public License
 * as published by the Free Software Foundation, version 3 of the License.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty
 * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Affero General Public License for more details.
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see http://www.gnu.org/licenses.
 *
 * Additional permission under GNU AGPL version 3 (AGPL-3.0) section 7
 *
 * If you modify this Program, or any covered work,
 * by linking or combining it with libraries listed
 * in COPYRIGHT file at the top-level directof of this
 * distribution (or a modified version of that libraries),
 * containing parts covered by the terms of licenses cited
 * in the COPYRIGHT file, the licensors of this Program
 * grant you additional permission to convey the resulting work.
-->
<chapter version="5.0" xml:lang="fr" xmlns="http://docbook.org/ns/docbook"
	xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:ns5="http://www.w3.org/2000/svg" xmlns:ns4="http://www.w3.org/1998/Math/MathML"
	xmlns:ns3="http://www.w3.org/1999/xhtml" xmlns:db="http://docbook.org/ns/docbook">
	<title>Single Sign On (SSO)</title>
	<sect2>
		<title>Central Authentication Service (CAS)</title>
	</sect2>
	<sect3>
		<title>Description</title>
		<para>CAS est utilisé dans sa version 3.5.0. CAS est un système
			d'authentification unique : un utilisateur s'authentifie
			sur le portail
			NovaForge, il devient alors authentifié sur tous les outils qui
			utilisent le même serveur CAS. Ce système évite à l'utilisateur de s'authentifier à chaque
			fois que l'on accède à une application en mettant en place un système
			de ticket. CAS est une application web JAVA hébergée par le conteneur de
			servlet TOMCAT. Il est installé dans le répertoire :
		</para>
		<programlisting language="shell"># $NOVA_HOME/engines/cas</programlisting>
	</sect3>
	<sect3>
		<title>Arrêt/Relance</title>
		<para>Un service permet d'arrêter/relancer le serveur :</para>
		<programlisting language="shell"># systemctl start cas
# systemctl stop cas</programlisting>
	</sect3>
	<sect3>
		<title>Fichiers de logs</title>
		<para>Les fichiers de journalisation se trouvent dans :</para>
		<programlisting language="shell"># $NOVA_HOME/logs/cas</programlisting>
	</sect3>
	<sect3>
		<title>Configuration SSL</title>
		<para>CAS nécessite l'activation SSL afin de respecter les standards
			de sécurité SSO et protéger le transit des logins et mots de passe.
			Le module SSL doit être activé par la facade web Apache. TOMCAT est
			configuré pour utiliser le connecteur SSL et doit importer les
			certificats SSL :
		</para>
		<para>
			<emphasis>$NOVA_HOME/engines/cas/conf/server.xml
			</emphasis>
			<programlisting language="xml"><![CDATA[<Connector port="8443" protocol="HTTP/1.1" SSLEnabled="true"
maxThreads="150" scheme="https" secure="true"
clientAuth="false" sslProtocol="TLS"
keystoreFile="${path_to_keystore}"
keystorePass="${keystore_password}" />]]></programlisting>
			<emphasis>$NOVA_HOME/bin/cas_forge</emphasis>
			<programlisting language="shell"># export JAVA_OPTS="[...]
-Djavax.net.ssl.keyStore=${path_to_keystore}
-Djavax.net.ssl.keyStorePassword=${keystore_password}
-Djavax.net.ssl.trustStore=${path_to_keystore}
-Djavax.net.ssl.trustStorePassword=${keystore_password}"</programlisting>
		</para>
	</sect3>
	<sect3>
		<title>Génération des certificats SSL</title>
		<programlisting language="shell" width="300px"> # openssl
pkcs12 -export -in novaforge-server.crt
-inkey novaforge-server.key -out novaforge-server.p12
-name ${cas_alias} -CAfile /path/to/novaforge-ca.crt
-caname root -passin pass:${keystore_password}
-passout pass:${keystore_password}

# $NOVA_HOME/engines/jre/bin/keytool -importkeystore
-deststorepass ${keystore_password}
-destkeypass ${keystore_password}
-destkeystore ${path_to_keystore}
-srckeystore /path/to/novaforge-server.p12
-srcstoretype PKCS12 -srcstorepass ${keystore_password}
-alias ${cas_alias}</programlisting>
	</sect3>
	<sect3>
		<title>Durée de vie des sessions</title>
		<para>Par défaut, une session expire au bout de deux heures et il est
			alors nécéssaire de se réauthentifier auprès de CAS pour regénérer
			un nouveau Ticket Granting Ticket.</para>	
			
		<para>Il est possible d'augmenter la durée de vie des sessions, en suivant la procédure suivante qui, dans l'exemple, augmente de 2 à 8 heures le temps avant expiration de la session.</para>
		
		<para>Stopper NovaForge et modifier le fichier de parametrage CAS ticketExpirationPolicies.xml</para>
		
		<programlisting language="shell"># cd $NOVA_HOME
# systemctl stop cas

# vi $NOVA_HOME/engines/cas/webapps/cas/WEB-INF/
	spring-configuration/ticketExpirationPolicies.xml</programlisting>
		
		<para>Modifier tgt.maxTimeToLiveInSeconds à 10h (36000 secondes) et tgt.timeToKillInSeconds à 8h (28800 secondes)</para>
			
        <programlisting language="xml"><![CDATA[<bean id="grantingTicketExpirationPolicy" 
class="org.jasig.cas.ticket.support.TicketGrantingTicketExpirationPolicy"
p:maxTimeToLiveInSeconds="${tgt.maxTimeToLiveInSeconds:36000}"
p:timeToKillInSeconds="${tgt.timeToKillInSeconds:28800}"/>]]></programlisting>
          
       	<para>Modifier la configuration de l'Apache Tomcat qui héberge CAS.</para>
          
        <programlisting language="shell"># vi $NOVA_HOME/engines/cas/conf/web.xml</programlisting>

		<para>Modifier le paramètre session-timeout à 479 minutes</para>
		
		<programlisting language="xml"><![CDATA[<session-timeout>479</session-timeout>]]></programlisting>
		
		<para>Modifier la session-timeout dans le WAR de l'UI du portail</para>
		
		<programlisting language="shell"># mkdir /tmp/novaforge-portal-ui
# cd $NOVA_HOME/engines/karaf/system/
	org/novaforge/forge/modules/novaforge-portal-ui/$TAG/
# cp novaforge-portal-ui-$TAG.war /tmp/novaforge-portal-ui
# cd /tmp/novaforge-portal-ui/
# unzip ./novaforge-portal-ui-$TAG.war

# vi ./WEB-INF/web.xml</programlisting>
		
		<para>Modifier le paramètres session-timeout puis reconstruire le WAR</para>
		
		<programlisting language="xml"><![CDATA[<session-timeout>479</session-timeout>]]></programlisting>
		
		<para>
       	<inlinemediaobject>
	   		<imageobject>
     			<imagedata fileref="02-dialog-warning.png" width="27px"/>
  			</imageobject>
		</inlinemediaobject>
		Attention, lors de l'edition du fichier web.xml, à ne pas de rajouter de saut de ligne</para>
		
		<programlisting language="shell"># zip -r novaforge-portal-ui-$TAG.war *
# cd $NOVA_HOME/engines/karaf/system/
org/novaforge/forge/modules/novaforge-portal-ui/$TAG/
# mv /tmp/novaforge-portal-ui/novaforge-portal-ui-$TAG.war .</programlisting>
		
		<para>Modifier le paramètres session-timeout dans le fichier de configuration org.ops4j.pax.web.cfg de Karaf.</para>
		<programlisting language="shell"># vi $NOVA_HOME/engines/karaf/etc/org.ops4j.pax.web.cfg</programlisting>
		
		<programlisting language="xml">org.ops4j.pax.web.session.timeout=479</programlisting>
		
		<para>Les modifications dans le fichier org.ops4j.pax.web.cfg sont prises à chaud, il n'est donc pas obligatoire de redémarrer Karaf.</para>
		
		<para>Il faut néanmoins redémarrer CAS et faire un update sur le Bundle <emphasis>NovaForge(tm) :: Modules :: Portal :: UI :: Main</emphasis> dans la console Gogo Shell.</para>
		
		<programlisting language="shell"># systemctl cas start</programlisting>
	</sect3>
</chapter>
