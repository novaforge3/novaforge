<?xml version="1.0" encoding="UTF-8"?>
<!--
 * Copyright (c) 2011-2015, BULL SAS, NovaForge Version 3 and above.
 *
 * This file is free software: you may redistribute and/or 
 * modify it under the terms of the GNU Affero General Public License
 * as published by the Free Software Foundation, version 3 of the License.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty
 * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Affero General Public License for more details.
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see http://www.gnu.org/licenses.
 *
 * Additional permission under GNU AGPL version 3 (AGPL-3.0) section 7
 *
 * If you modify this Program, or any covered work,
 * by linking or combining it with libraries listed
 * in COPYRIGHT file at the top-level directof of this
 * distribution (or a modified version of that libraries),
 * containing parts covered by the terms of licenses cited
 * in the COPYRIGHT file, the licensors of this Program
 * grant you additional permission to convey the resulting work.
-->
<chapter version="5.0" xml:lang="fr" xmlns="http://docbook.org/ns/docbook"
	xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:ns5="http://www.w3.org/2000/svg" xmlns:ns4="http://www.w3.org/1998/Math/MathML"
	xmlns:ns3="http://www.w3.org/1999/xhtml" xmlns:db="http://docbook.org/ns/docbook">
	<title>Gestion des alertes et Statistiques d'utilisation</title>
	<sect1>
		<title>Gestion des alertes</title>
		<sect2>
			<title>Description</title>
			<para>La gestion des alertes est essentielle pour NovaForge, elle permet de prévenir les problèmes et de gagner en réactivité.</para>
			<para>Voici une liste non exhaustive d'outils permettant de gérer les alertes : Nagios, Centreon, Shinken, Zabbix, OpenNMS, EyesOfNetwork, Groundwork, Zenoss, Vigilo, Icinga, Cacti.</para>
		</sect2>
		<sect2>
			<title>Bonnes pratiques</title>
			<para>
				Voici quelques bonnes pratiques liées à l'outil de gestion des alertes que nous recommandons :
			</para>
			<itemizedlist>
				<listitem>
					<para>Installer l'outil sur un serveur dédié, afin de garantir la stabilité de celui-ci et de pouvoir surveiller la disponibilité des serveurs NovaForge.
					</para>
				</listitem>
				<listitem>
					<para>Définir une mailing list comme destinataire des alertes, gérée par un outil qui n'est pas l'outil de mailing list de NovaForge.
					</para>
				</listitem>
			</itemizedlist>
		</sect2>
		<sect2>
			<title>Alertes à mettre en place</title>
			<para>Il existe trois types de surveillance pouvant être mis en place :</para>
			<itemizedlist>
				<listitem>
					<para>Les surveillances web qui vont vérifier, la disponibilité, le temps de réponse et le contenu des applications web.</para>
				</listitem>
				<listitem>
					<para>Les surveillances processus, qui vont vérifier la présence des processus sur le serveur.</para>
				</listitem>
				<listitem>
					<para>Les surveillances systèmes, qui vont vérifier le bon fonctionnement du serveur.</para>
				</listitem>		
			</itemizedlist>
			<para>Ci-dessous nous détaillons les trois types de surveillances.</para>
			<sect3>
				<title>Surveillances Web</title>
				<para>Pour chaque application web, il faut surveiller :</para>
				<itemizedlist>
					<listitem>
						<para>La disponibilité de l'applications web : interroger (<emphasis>ping</emphasis>) l'application à intervalles réguliers</para>
					</listitem>
					<listitem>
						<para>Le temps de réponse de l'application web : définir un seuil d'alerte</para>
					</listitem>
					<listitem>
						<para>Le contenu de l'application web : différencier les pages d'erreurs des pages applicatives en détectant la balise META</para>
					</listitem>
				</itemizedlist>
				<para>Les applications web de NovaForge à surveiller sont les suivantes :</para>
				
				<table frame="all">
					<title>Application web à surveiller</title>
						<tgroup cols="2" align="left" colsep="1" rowsep="1">
							<colspec colnum="1" colname="col1" colwidth="1*"/>
							<colspec colnum="2" colname="col2" colwidth="3*"/>
							<thead>
								<row>
									<entry>Nom</entry>
									<entry>URL</entry>
								</row>
							</thead>
							<tbody>
								<row>
									<entry>Le portail de NovaForge</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/portal/public/</entry>
								</row>
								<row>
									<entry>CAS, le SSO de Novaforge</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/cas/</entry>
								</row>
								<row>
									<entry>La Homepage de NovaForge</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/forge-first/</entry>
								</row>
								<row>
									<entry>L'aide en ligne de NovaForge</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/forge-help/</entry>
								</row>
								<row>
									<entry>L'outil Sonar</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/sonar/</entry>
								</row>
								<row>
									<entry>L'outil Jenkins</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/securityRealm/commenceLogin/</entry>
								</row>
								<row>
									<entry>L'outil Nexus</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/nexus/</entry>
								</row>
								<row>
									<entry>L'outil Alfresco</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/alfresco/</entry>
								</row>
								<row>
									<entry>L'outil Share d'Alfresco</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/share/</entry>
								</row>
								<row>
									<entry>L'outil de livraison</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/delivery-management/</entry>
								</row>
								<row>
									<entry>L'outil Dokuwiki</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/dokuwiki/</entry>
								</row>
								<row>
									<entry>L'outil Limesurvey</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/limesurvey/</entry>
								</row>
								<row>
									<entry>L'outil Mantis</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/mantis/</entry>
								</row>
								<row>
									<entry>L'outil Jira</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/jira/</entry>
								</row>
								<row>
									<entry>L'outil Phpbb</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/phpbb/</entry>
								</row>
								<row>
									<entry>L'outil des Exigences</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/requirements</entry>
								</row>
								<row>
									<entry>L'outil Spip</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/spip</entry>
								</row>
								<row>
									<entry>L'outil SVN</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/svn</entry>
								</row>
								<row>
									<entry>L'outil d'exploration de dépot Svn</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/svnRepositoryViewer</entry>
								</row>
								<row>
									<entry>L'outil Sympa</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/sympa</entry>
								</row>
								<row>
									<entry>L'outil Testlink</entry>
									<entry>https://{NOVAFORGEHOST}/{INSTANCEALIAS}/testlink</entry>
								</row>
							</tbody>
						</tgroup>
					</table>
					<sect4>
						<title>Mise en place</title>
						<para>Depuis l'outil de Monitoring, créer une sonde de type "HTTP" avec l'url de l'application en paramètre, et
						configurer les types et seuils d'alertes voulus (temps de réponse, code HTTP attendu etc...).</para>
						<para>
							<inlinemediaobject>
								<imageobject>
									<imagedata fileref="02-dialog-warning.png" width="27px" />
								</imageobject>
							</inlinemediaobject>
							Attention, la valeur de {INSTANCEALIAS} est "/" par défaut, mais pour certains outils qui peuvent 
							posséder plusieurs instances, cette valeur peut être retrouvée dans la colonne "ALIAS" de l'onglet 
							"Administrate Plugins" >> "Manage Instance of this plugin".
						</para>
						<figure>
							<title>La colonne Alias permet de récupérer la variable {INSTANCEALIAS} pour chaque outil</title>
							<mediaobject>
								<imageobject>
									<imagedata align="center" fileref="09-nagios-jenkins.png"
										width="450px" />
								</imageobject>
							</mediaobject>
						</figure>
						<para>Les outils Jenkins et Sonar peuvent possèder plusieurs instances et il faudra créer autant de sonde HTTP qu'il y a d'instances</para>	
					</sect4>
			</sect3>
			<sect3>
				<title>Surveillances Processus</title>
				<para>Cette surveillance concerne toutes les applications non web de NovaForge 
				(ex.: les bases de données, serveur d'application). On peut aussi surveiller les processus des applications
				 web (ex.: le tomcat d'Alfresco) car certains outils permettent de les relancer automatiquement en cas d'arrêt.
				</para>
				<para>Les processus suivant sont à surveiller :</para>
				<itemizedlist>
					<listitem>
						<para>httpd : le serveur web Apache</para>
					</listitem>
					<listitem>
						<para>mysqld : le serveur de base de données MariaDB</para>
					</listitem>
					<listitem>
						<para>sympa.pl, bulk.pl, archived.pl, bounced.pl, task_manager.pl : l'ensemble des processus de l'outil de mailing list Sympa
						</para>
					</listitem>
					<listitem>
						<para>sendmail (ou autre serveur de messagerie): le serveur de messagerie
						</para>
					</listitem>
					<listitem>
						<para>le tomcat de CAS: l'outil de Single Sign On de NovaForge</para>
					</listitem>
					<listitem>
						<para>le tomcat d'Alfresco: l'outil de GED de NovaForge</para>
					</listitem>
					<listitem>
						<para>le serveur d'application de Nexus: l'outil de gestion des
							dépôts Maven de NovaForge
						</para>
					</listitem>
					<listitem>
						<para>le serveur d'application de Sonar: l'outil de gestion de
							qualité de NovaForge
						</para>
					</listitem>
				</itemizedlist>
				<para>Depuis l'outil de Monitoring, créer une sonde de type "processus" avec le chemin du processus. Il est nécessaire d'installer ces sondes à la fois sur le serveur surveillé et sur le serveur de monitoring.</para>
			</sect3>
			<sect3>
				<title>Surveillances Système</title>
				<para>Les ressources système à surveiller sont :</para>
				<itemizedlist>
					<listitem>
						<para>Processeur : le taux d'utilisation du processeur</para>
					</listitem>
					<listitem>
						<para>Mémoire : le taux d'utilisation de la mémoire, le taux d'utilisation du "swap</para>
					</listitem>
					<listitem>
						<para>L'espace disque : l'espace disque disponible sur l'ensemble des volumes/partitions utilisés par NovaForge</para>

						<para>Certaines fonctionnalités sont suceptibles d'occuper beaucoup d'espace disque :</para>
						<itemizedlist>
							<listitem>
								<para>Historisation des événements applicatifs</para>
							</listitem>	
							<listitem>
								<para>Subversion</para>
							</listitem>	
							<listitem>	
								<para>Nexus</para>
							</listitem>	
							<listitem>	
								<para>Sonar</para>
							</listitem>	
							<listitem>
								<para>Jenkins</para>
							</listitem>	
							<listitem>
								<para>Spip</para>
							</listitem>	
							<listitem>
								<para>Alfresco</para>
							</listitem>
						</itemizedlist>
					</listitem>
				</itemizedlist>
				<para>Depuis l'outil de Monitoring, créer une sonde de type "serveur" et définir un seuil d'alerte.
				Il est nécessaire d'installer ces sondes à la fois sur le serveur surveillé et sur le serveur de monitoring.</para>
			</sect3>
		</sect2>
	</sect1>
	<sect1>
		<title>Statistiques d'utilisation</title>
		<para>L'outil de surveillance en temps réel de NovaForge permet de suivre l'évolution de
		 l'utilisation des ressources (processeur, mémoire, espace disque, bande passante, etc.). Il permet :</para>
			<itemizedlist>
				<listitem>
					<para>d'ajuster les seuils d'alerte de l'outil de Gestion des alertes</para>
				</listitem>	
				<listitem>
					<para>de prévenir les besoins d'évolution du serveur (disque/mémoire supplémentaire)</para>
				</listitem>			
			</itemizedlist>
		<para>La plupart des outils précédement évoqués permettent d'obtenir ces informations nativement ou à l'aide de modules complémentaires.</para>
	</sect1>
	<sect1>
		<title>Monitoring de NovaForge avec Nagios et NPRE</title>
		<sect2>
			<title>Vue d'ensemble</title>
			<para>L'outil de gestion d'alerte recommandé par l'équipe NovaForge est l'application Nagios. C'est un outil
			 libre permettant un monitoring modulable qui, couplé à son add-on Nagios Remote Plugin Executor (NRPE), permet de surveiller
			  un ensemble de serveurs via une interface et un système de notification e-mail.</para>
		
			<para>Nagios permet l'utilisation de scripts locaux qui sont localisés sur le serveur de monitoring,
			par défaut dans <filename class='directory'>/usr/lib64/nagios/plugins</filename>. Ces scripts retournent 
			un code dont la signification est la suivante :</para>
			
			<itemizedlist>
				<listitem>
			    	<para>Code 0: OK - Tout va bien</para>
			  	</listitem>
				<listitem>
					<para>Code 1: WARNING - Alerte</para>
				</listitem>
				<listitem>
					<para>Code 2: CRITICAL - Alerte critique</para>
				</listitem>
				<listitem>
					<para>Code 3: UNKNOWN - Problème lors de l'exécution du plugin</para>
				</listitem>
			</itemizedlist>
			
			Par exemple le script <filename class='directory'>/usr/lib64/nagios/plugins/check_http</filename> ping une URL puis retourne un code HTTP. Le code retour du script sera défini en fonction du code HTTP recu : 
			
			<itemizedlist>
				<listitem>
			    	<para>Code HTTP 200 / 300 : OK </para>
			  	</listitem>
				<listitem>
					<para>Code HTTP 400 : WARNING </para>
				</listitem>
				<listitem>
					<para>Code HTTP 500 : CRITICAL </para>
				</listitem>
			</itemizedlist>
			
			<figure>
				<title>Exemple d'IHM Nagios : les statut des serveurs monitorés</title>
				<mediaobject>
					<imageobject>
						<imagedata align="center" fileref="09-nagios-hosts.png"
							width="450px" />
					</imageobject>
				</mediaobject>
			</figure>
			
			<para>Les versions de Nagios et NRPE recommandées pour NovaForge 3 sont les suivantes :</para>
		  	<itemizedlist>
				<listitem>
			    	<para>Nagios 3.2.3</para>
			  	</listitem>
				<listitem>
					<para>Nagios Plugins 1.4.16, ce plugin est nécessaire sur tous les serveurs</para>
				</listitem>
				<listitem>
					<para>NRPE 2.14</para>
				</listitem>
			</itemizedlist>
		
			<para>Le plugin NRPE est un Addon de Nagios qui permet l'exécution de scripts directement sur les machines à monitorer et retourne le résultat au serveur de monitoring. Ainsi il permet de surveiller les processus et les informations sur les systèmes à monitorer (SWAP, LOAD, etc...).</para>
			<figure>
				<title>Architecture Nagios/NRPE</title>
				<mediaobject>
					<imageobject>
						<imagedata align="center" fileref="09-nagios-nrpe-scheme.jpg"
							width="300px" />
					</imageobject>
				</mediaobject>
			</figure>
			<para>Le plugin Nagios NPRE est situé sur le serveur de monitoring dans le dossier suivant : <filename class='directory'>/usr/lib64/nagios/plugins/check_nrpe</filename></para>	
		</sect2>
		
		<sect2>
			<title>Description de l'installation</title>
			<para>Le script d'installation et de configuration regroupe les étapes suivantes : </para>
		    <itemizedlist>
				<listitem>
			    	<para>Installation de Nagios 3.2.3 sur le serveur de monitoring</para>
			  	</listitem>
				<listitem>
					<para>Installation et configuration de sendmail sur le serveur de monitoring afin de pouvoir envoyer des alertes;</para>
				</listitem>
				<listitem>
					<para>Installation et configuration de Apache sur le serveur de monitoring afin de pouvoir accéder à l'IHM de monitoring;</para>
				</listitem>
				<listitem>
					<para>Installation de NRPE 2.14 sur les serveur à monitorer</para>
				</listitem>
				<listitem>
					<para>Configuration de Nagios sur le serveur de monitoring (Hosts, Contacts, Services, Commandes)</para>
				</listitem>
				<listitem>
					<para>Configuration de NRPE sur les serveurs à monitorer (Commandes)</para>
				</listitem>
			</itemizedlist>
		</sect2>
		
		<sect2>
			<title>Configurations spécifique pour NovaForge</title>
			<sect3>
				<title>Serveur de monitoring</title>
				<para>Sur le serveur de monitoring, le fichier <filename class='directory'>/etc/nagios/nagios.cfg</filename> étend la 
				configuration par défaut avec trois nouveaux fichiers de configuration spécifiques pour NovaForge.</para>
				<programlisting language="shell"># You can specify individual object config files as shown below :
cfg_file=/etc/nagios/objects/commands.cfg
cfg_file=/etc/nagios/objects/contacts.cfg
cfg_file=/etc/nagios/objects/timeperiods.cfg
cfg_file=/etc/nagios/objects/templates.cfg
cfg_file=/etc/nagios/objects/novaforge-commands.cfg 
cfg_file=/etc/nagios/objects/novaforge-contacts.cfg 
cfg_file=/etc/nagios/objects/novaforge.cfg</programlisting>
				<itemizedlist>
				<listitem>
			    	<para><filename class='directory'>/etc/nagios/objects/novaforge.cfg</filename> : défini des 
			    	HOSTS et des SERVICES (i.e. qui et quoi monitorer)</para>
			  	</listitem>
				<listitem>
					<para><filename class='directory'>/etc/nagios/objects/novaforge-commands.cfg</filename> : défini des 
					COMMANDES de service et de notification (i.e. comment monitorer et notifier)</para>
				</listitem>
				<listitem>
					<para><filename class='directory'>/etc/nagios/objects/novaforge-contacts.cfg</filename> : défini des 
					CONTACTS à notifier (i.e. qui notifier)</para>
				</listitem>
			</itemizedlist>
			
				<para>Exemple de définition d'un HOST : </para>
				<programlisting language="shell"># Define a host for the portal
define host{
	host_name      Portal
	use            generic-host
	address        ${HOST_PORTAL}
	check_command  check_alive
	contact        novaforgeadmin
}</programlisting>

<para>Exemple de définition d'un SERVICE : </para>
				<programlisting language="shell"># Define a service to check freespace on /datas
define service{
	name                 novaforge-datas-freespace
	use                  generic-service
	service_description  SYS Freespace on /datas
	check_command        check_datas_freespace
	host_name            Portal
	register             1
}</programlisting>

				<para>Exemple de définition d'un CONTACT : </para>
				<programlisting language="shell"># Define a contact for the Portal
define contact{
	contact_nane                   novaforgeadmin
	name                           novaforgeadmin
	use                            generic-contact
	email                          email@localhost
	service_notification_period    24x7
	host_notification_period       24x7
	service_notification_options   w,u,c,r,f,s
	host_notification_options      d,u,r,f,s
	service_notification_commands  notify-service-by-email
	host_notification_commands     notify-host-by-email
	register                       1
}</programlisting>

				<para>Exemple de définition d'une COMMANDE : </para>
				<programlisting language="shell">define command{
	command_name   check_datas_freespace
	command_line   $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_disk_datas
}</programlisting>

			</sect3>
			<sect3>
				<title>Serveurs à monitorer</title>
				<para>Le fichier <filename class='directory'>/etc/nagios/nrpe.cfg</filename> répertorie toutes les commandes à exécuter
				 sur les serveurs à monitorer (i.e. surveillance des processus et du système).</para>
				<para>Voici un exemple de commande qui lève :</para>
				<itemizedlist>
					<listitem>
				    	<para>une alerte critique quand l'espace disque sur /datas devient inferieur à 10%</para>
				  	</listitem>
				  	<listitem>
				    	<para>une alerte warning quand l'espace disque sur /datas devient inferieur à 25% </para>
				  	</listitem>
				</itemizedlist>
				
				<programlisting language="shell">command[check_disk_datas]=/usr/lib64/nagios/plugins/check_disk 
				-w 25% -c 10%  -p /datas</programlisting>
			</sect3>
			<sect3>
				<title>Aperçu des IHM</title>
				<para>L'IHM Nagios apportant le plus d'information est celle des "Services" (encadrée ci-dessous)</para>
				<figure>
					<title>Menu de l'IHM Nagios</title>
					<mediaobject>
						<imageobject>
							<imagedata align="center" fileref="09-nagios-menu.png"
								width="100px" />
						</imageobject>
					</mediaobject>
				</figure>
				<para>Ci dessous un exemple de situation où :</para>
				<itemizedlist>
					<listitem>
				    	<para>Le service Jenkins n'est pas démarré, le "ping" de l'application web (service HTTP Jenkins) 
				    	et la sonde au niveau du processus jenkins (service PROCS Jenkins) renvoient un status critique</para>
				  	</listitem>
				  	<listitem>
				    	<para>Le service système SYS Freespace on /datas renvoie un warning car l'espace disponible est inférieur à 25%</para>
				  	</listitem>
				</itemizedlist>
				<figure>
					<title>IHM des services pour NovaForge</title>
					<mediaobject>
						<imageobject>
							<imagedata align="center" fileref="09-nagios-services-critiques.png"
								width="450px" />
						</imageobject>
					</mediaobject>
				</figure>
			</sect3>	
		</sect2>
	</sect1>
</chapter>