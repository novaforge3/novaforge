<?xml version="1.0" encoding="UTF-8"?>
<!--
  * Copyright (c) 2011-2015, BULL SAS, NovaForge Version 3 and above.
  *
  * This file is free software: you may redistribute and/or modify it under
  * the terms of the GNU Affero General Public License as published by the
  * Free Software Foundation, version 3 of the License.
  *
  * This file is distributed in the hope that it will be useful,
  * but WITHOUT ANY WARRANTY; without even the implied warranty
  * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
  * See the GNU Affero General Public License for more details.
  * You should have received a copy of the GNU Affero General Public License
  * along with this program. If not, see http://www.gnu.org/licenses.
  *
  * Additional permission under GNU AGPL version 3 (AGPL-3.0) section 7.
  *
  * If you modify this Program, or any covered work, by linking or combining
  * it with libraries listed in COPYRIGHT file at the top-level directory of
  * this distribution (or a modified version of that libraries), containing parts
  * covered by the terms of licenses cited in the COPYRIGHT file, the licensors
  * of this Program grant you additional permission to convey the resulting work.
  -->
<chapter version="5.0" xml:lang="fr" xmlns="http://docbook.org/ns/docbook"
		>
	
	<title>Logs - Rolling Quotidien</title>
	<sect2>
		<title>Configuration des Logs pour Rolling quotidien</title>
	</sect2>
	<sect3>
		<title>Introduction</title>
		<para>Le but de cette partie est de présenter les modifications à effectuer dans les configuration des logs pour obtenir un rolling quotidien de ceux-ci sur les différents plugins de la forge.</para>
	</sect3>
	<sect3>
		<title>Apache</title>
		<sect4>
			<title>Localisation des logs</title>
			<para>Les logs apaches sont présents dans le dossier $NOVA_HOME/logs/httpd :</para>
			<itemizedlist mark='opencircle'>
				<listitem><para>http.error.log : contenant les erreurs du serveur Apache</para></listitem>
				<listitem><para>http.log : contenant les différents accès au serveur (requêtes post/get...)</para></listitem>
			</itemizedlist>
		</sect4>
		<sect4>
			<title>Modifications</title>
			<para>Pour obtenir un rolling quotidien des logs Apache, il existe deux possibilités.</para>
			<sect5>
				<title>Solution avec installation</title>
				<orderedlist numeration="arabic">
					<listitem>
					<para>Installer le paquet cronolog</para>
					</listitem>
					<listitem>
					<para>Modifier les premières lignes du fichier $NOVA_HOME/system/httpd/conf.d/novaforge.conf pour obtenir ceci :</para>
					</listitem>
				</orderedlist>
				<programlisting language="shell">-> ErrorLog  "|/usr/bin/cronolog 
<![CDATA[<NOVA_HOME>]]>/logs/httpd/%Y-%m-%d/http.error.log"
				
-> CustomLog "|/usr/bin/cronolog 
<![CDATA[<NOVA_HOME>]]>/logs/httpd/%Y-%m-%d/http.log" combined</programlisting>
				<para>Cette modification permettra de lancer cronolog lors de l'accès aux logs et ainsi, le cas échéant, faire le basculement des logs sur une base quotidienne</para>
			</sect5>
			<sect5>
				<title>Solution sans installation</title>
				<para>Cette solution ne nécessite pas d'installer un programme tiers pour effectuer le rolling mais présente l'inconvénient de devoir arrêter le serveur Apache pour effectuer le rolling via un script.</para>
				<para>Le script suivant permet d'effectuer le rolling :</para>
				<programlisting language="shell">mv http.log http.log.YYYYMMDD
mv http.error.log http.error.log.YYYYMMDD
apachectl graceful
sleep 600
gzip http.log.YYYYMMDD http.error.log.YYYYMMDD</programlisting>
			</sect5>
		</sect4>
	</sect3>
	<sect3>
		<title>CAS</title>
		<sect4>
			<title>État des lieux</title>
			<para>Il existe actuellement un rolling sur le fichier de log "cas.log" sur une base de taille (512KB) et non de date.</para>
			<para>Le fichier de log perfStats.log ne présente pas de rolling.</para>
		</sect4>
		<sect4>
			<title>Modifications</title>
			<para>La modification se fera dans le fichier suivant :</para>
			<para>$NOVA_HOME/engines/cas/webapps/cas/WEB-INF/classes/log4j.xml</para>
			<para>La syntaxe étant à base de log4j, il faudra utiliser un logger de type DailyRollingFileAppender comme suit :</para>
			<programlisting language="shell">log4j.appender.File=org.apache.log4j.DailyRollingFileAppender
log4j.appender.File.DatePattern='.'yyyy-MM-dd</programlisting>
			<para>De même, CAS utilisant d'autres fichiers de logs (catalina.log, localhost.log, manager.log, host-manager.log), un rolling quotidien devra être défini aussi.</para>
			<para>La configuration de ces fichiers de logs est définie dans $NOVA_HOME/engines/cas/conf/logging.properties avec une syntaxe de type JUL (Java Util Logging)</para>
			<para>Il faudra donc ajouter les lignes suivantes à ce fichier :</para>
			<programlisting language="shell">1catalina.org.apache.juli.FileHandler.rotatable = true
2localhost.org.apache.juli.FileHandler.rotatable = true
3manager.org.apache.juli.FileHandler.rotatable = true
4host.org.apache.juli.FileHandler.rotatable = true</programlisting>
		</sect4>
	</sect3>
	<sect3>
		<title>Karaf</title>
		<sect4>
			<title>Localisation des logs</title>
			<para>Les logs Karaf sont présents dans $NOVA_HOME/logs/karaf/karaf.log.</para>
			<para>La fichier de configuration des logs est situé dans :</para>
			<para>$NOVA_HOME/engines/karaf/etc/org.ops4j.pax.logging.cfg</para>
		</sect4>
		<sect4>
			<title>Modifications</title>
			<para>Il faut modifier le fichier de configuration etc/org.ops4j.pax.logging.cfg pour obtenir les lignes suivantes :</para>
			<programlisting language="shell">log4j.appender.out.file=
<![CDATA[<NOVA_HOME>]]>/logs/karaf/karaf.YYYYMMDD_MM_mm.log

log4j.appender.out.rollmode=DATE
log4j.appender.sift.appender.file=
${karaf.data}/log/$\\{bundle.name\\}.YYYYMMDD_MM_mm.log

log4j.appender.sift.appender.rollmode=DATE</programlisting>
		</sect4>
	</sect3>
	<sect3>
		<title>Nexus</title>
		<sect4>
			<title>Localisation des logs</title>
			<para>Le fichier de logs des démarrages et arrêts de Nexus est présent, avec un rolling quotidien, dans :</para>
			<para>$NOVA_HOME/logs/nexus_forge/yyymmdd-hhmm-nexus_forge.log</para>
			<para>La configuration associée à ce fichier de log est dans le script de lancement de Nexus :</para>
			<para>$NOVA_HOME/bin/nexus_forge</para>			
		</sect4>
		<sect4>
			<title>Modifications</title>
			<para>Il reste à modifier le fichier de log wrapper_nexus.log, présent dans :</para>
			<para>$NOVA_HOME/logs/nexus/wrapper_nexus.log</para>
			<para>Sa configuration à modifier est située dans le fichier suivant :</para>
			<para>$NOVA_HOME/engines/nexus/bin/jsw/conf/wrapper.conf</para>
			<para>Il faut ajouter les lignes suivantes dans le fichier :</para>
			<programlisting language="shell">wrapper.logfile=<![CDATA[<NOVA_HOME>]]>/logs/nexus/wrapper_nexus.YYYYMMDD_MM_mm.log
wrapper.logfile.rollmode=DATE</programlisting>
		</sect4>
	</sect3>
	<sect3>
		<title>Sonar</title>
		<sect4>
			<title>État des lieux</title>
			<para>Des fichiers de logs internes à Sonar sont présents dans le dossier :</para>
			<para>$NOVA_HOME/engines/sonar/logs</para>
			<para>Il existe actuellement un rolling sur une base de taille (5MB) et non de date sur le fichiers de log suivants :</para>
			<itemizedlist mark='opencircle'>
				<listitem><para>sonar.log => rolling sur 5MB</para></listitem>
				<listitem><para>profiling.log => rolling sur 5MB</para></listitem>
			</itemizedlist>
			<para>La configuration associée à ces deux fichiers de logs est :</para>
			<para>$NOVA_HOME/engines/sonar/conf/logback.xml</para>
			<para></para>
			<para>Un autre fichier de log est présent dans :</para>
			<para>$NOVA_HOME/logs/sonar/sonar.log</para>
		</sect4>
		<sect4>
			<title>Modifications</title>
			<para>La configuration du fichier de log $NOVA_HOME/logs/sonar_forge/sonar.log doit être modifiée pour obtenir un rolling quotidien.</para>
			<para></para>
			<para>Cette configuration est située dans :</para>
			<para>$NOVA_HOME/engines/sonar/conf/wrapper.conf</para>
			<para>Il faut donc ajouter les lignes suivantes :</para>
			<programlisting language="shell"># Log file to use for wrapper output logging.
wrapper.logfile=<![CDATA[<NOVA_HOME>]]>/logs/sonar/sonar.YYYYMMDD.log

# Rolling on date
wrapper.logfile.rollmode=DATE</programlisting>
		</sect4>
	</sect3>
	<sect3>
		<title>Tomcat / Alfresco</title>
		<sect4>
			<title>État des lieux</title>
			<para>Le fichiers de logs sont présents dans :</para>
			<para>$NOVA_HOME/logs/alfresco</para>
			<para></para>
			<para>Le fichier de log alfresco.log.yyyy-MM-dd possède déjà un rolling quotidien paramétré dans :</para>
			<para>$NOVA_HOME/engines/nova-alfresco/webapps/alfresco-default#alfresco/WEB-INF/classes/log4j.properties</para>
			<para></para>
			<para>Un autre fichier de log, hibernate.log, est présent sans rolling quotidien.</para>
		</sect4>
		<sect4>
			<title>Modifications</title>
			<para>Il faut donc modifier la configuration de hibernate.log présente dans :</para>
			<para>$NOVA_HOME/engines/nova-alfresco/webapps/alfresco-default#alfresco/WEB-INF/classes/log4j.properties avec une syntaxe log4j.</para>
			<para></para>
			<para>Modifier les lignes suivantes :</para>
			<programlisting language="shell">log4j.appender.File=org.apache.log4j.DailyRollingFileAppender
log4j.appender.File.DatePattern='.'yyyy-MM-dd</programlisting>
		</sect4>
	</sect3>
</chapter>
