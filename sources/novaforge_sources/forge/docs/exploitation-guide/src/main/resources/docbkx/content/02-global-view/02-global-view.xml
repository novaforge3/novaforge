<?xml version="1.0" encoding="UTF-8"?>
<!--
 * Copyright (c) 2011-2015, BULL SAS, NovaForge Version 3 and above.
 *
 * This file is free software: you may redistribute and/or 
 * modify it under the terms of the GNU Affero General Public License
 * as published by the Free Software Foundation, version 3 of the License.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty
 * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Affero General Public License for more details.
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see http://www.gnu.org/licenses.
 *
 * Additional permission under GNU AGPL version 3 (AGPL-3.0) section 7
 *
 * If you modify this Program, or any covered work,
 * by linking or combining it with libraries listed
 * in COPYRIGHT file at the top-level directof of this
 * distribution (or a modified version of that libraries),
 * containing parts covered by the terms of licenses cited
 * in the COPYRIGHT file, the licensors of this Program
 * grant you additional permission to convey the resulting work.
-->
<chapter version="5.0" xml:lang="fr" xmlns="http://docbook.org/ns/docbook"
	xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:ns5="http://www.w3.org/2000/svg" xmlns:ns4="http://www.w3.org/1998/Math/MathML"
	xmlns:ns3="http://www.w3.org/1999/xhtml" xmlns:db="http://docbook.org/ns/docbook">
	<title>Vue Globale</title>

	<sect2>
		<figure>
			<title>Un exemple de déploiement de NovaForge(TM) sur 4 machines
			</title>
			<mediaobject>
				<imageobject>
					<imagedata align="center" fileref="03-archi.png"
						width="500px" />
				</imageobject>
			</mediaobject>
		</figure>
		<title>Schéma d'architecture</title>
		<para>Ce schéma présente une installation sur quatres machines
			virtuelles. PIC, GED et SVN sont dit "déportés" :
		</para>

		<itemizedlist spacing="compact">
			<listitem>
				<para>
					<emphasis role="bold">Portail</emphasis>
					: héberge le coeur de forge et les outils suivants :
				</para>
				<itemizedlist spacing="compact">
					<listitem>
						<para>Nexus</para>
					</listitem>
					<listitem>
						<para> Des applications PHP comme Testlink, Mantis ou
							DokuWiki
						</para>
					</listitem>
					<listitem>
						<para>Sympa</para>
					</listitem>
				</itemizedlist>
			</listitem>
			<listitem>
				<para>
					<emphasis role="bold">SVN</emphasis>
					: héberge l'outil SVN
				</para>
			</listitem>
			<listitem>
				<para>
					<emphasis role="bold">GED</emphasis>
					(Gestion Electronique de Document) : héberge l'outil Alfresco
				</para>
			</listitem>
			<listitem>
				<para>
					<emphasis role="bold">PIC</emphasis>
					(Plateforme d'Intégration Continue) : héberge les outils Jenkins et
					Sonar
				</para>
			</listitem>
		</itemizedlist>

		<para>Il existe uniquement deux points d'entrée sur NovaForge :</para>
		<itemizedlist>
			<listitem>
				<para>Par le serveur frontal Apache en HTTPS sur le port 443</para>
			</listitem>
			<listitem>
				<para>Par le MTA (Mail Transfert Agent) SendMail en SMTP sur le port
					25 (port par défaut) utilisé uniquement par l'outil Sympa pour recevoir les mails à
					diffuser
				</para>
			</listitem>
		</itemizedlist>

		<figure>
			<title>Autre exemple de déploiement de NovaForge(TM) sur 2 machines
			</title>
			<mediaobject>
				<imageobject>
					<imagedata align="center" fileref="04-archi-safran.png"
						width="500px" />
				</imageobject>
			</mediaobject>
		</figure>
		<para>Ce schéma présente une installation sur deux machines virtuelles
			avec les mêmes outils que le schéma précédent.
		</para>
	</sect2>

	<sect2>
		<title>Vue de l'arboresence</title>
		<figure>
			<title>Vue de l'arboresence</title>
			<mediaobject>
				<imageobject>
					<imagedata align="center" fileref="01-treeview.png"
						width="450px" />
				</imageobject>
			</mediaobject>
		</figure>
	</sect2>

	<sect3>
		<title>Description</title>
		<para>
			Comme le montre le schéma ci-dessus, l'installation sur le système de
			fichier est découpée par catégorie :
			<itemizedlist>
				<listitem>
					<para>
						<emphasis role="bold">logs</emphasis>
						 : contient l'ensemble des journaux applicatifs avec un classement
						par produits
						(hormis certains cas particuliers que nous
						mentionnerons au fil de l'eau). On y trouve par exemple les fichiers de logs de Karaf, MySql ou Apache
					</para>
				</listitem>
				<listitem>
					<para>
						<emphasis role="bold">engines</emphasis>
						: contient le coeur applicatif de chacun des produits et leurs configurations 
					</para>
				</listitem>
				<listitem>
					<para>
						<emphasis role="bold">datas</emphasis>
						: permet le stockage des données liées à l'utilisation des
						produits
					</para>
				</listitem>
				<listitem>
					<para>
						<emphasis role="bold">bin</emphasis>
						: permet le lancement des produits via divers scripts
					</para>
				</listitem>
				<listitem>
					<para>
						<emphasis role="bold">tmp</emphasis>
						: contient des données stockées de façon temporaire par
						l'application
					</para>
				</listitem>
			</itemizedlist>
		</para>
	</sect3>
	<sect3>
		<title>Utilisateurs et groups</title>
		<para>
			Par défaut, le propriétaire (utilisateur et groupe) de l'arboresence d'une forge est l'utilisateur par défaut (novaforge).
			Les exceptions sont les suivantes :
			<itemizedlist>
				<listitem>
				<para>
						<emphasis role="bold">Scrits et applications PHP</emphasis>
						: L'utilisateur système "apache" est propriétaire des fichiers et dossiers
					</para>
				</listitem>
				<listitem>
				<para>
						<emphasis role="bold">Moteur de base de donées (mariadb)</emphasis>
						: L'utilisateur système "mysql" est propriétaire des fichiers de base, fichiers de configuration,  logs et binaires
					</para>
				</listitem>
				<listitem>
				<para>
						<emphasis role="bold">Moteur de gestion de liste de diffusion e-mail Sympa</emphasis>
						: L'utilisateur système "sympa" est propriétaire des fichiers de données, de configuration, et binaires, l'utilisateur système "root" est propriétaire des logs
					</para>
				</listitem>
				<listitem>
				<para>
						<emphasis role="bold">Moteur de gestion de version Gitlab</emphasis>
						: L'utilisateur système "root" est propriétaire des fichiers de configuration, de données, de logs et binaires
					</para>
				</listitem>
			</itemizedlist>
		</para>
	</sect3>
		<sect4>
			<title>Cas d'une forge AIO</title>
<programlisting>
<![CDATA[
/datas/safran/
├── [safran   safran  ]  bin
│   ├── [safran   safran  ]  alfresco
│   ├── [safran   safran  ]  cas
│   ├── [safran   safran  ]  gitlab
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  jira
│   ├── [safran   safran  ]  karaf
│   ├── [safran   safran  ]  nexus
│   └── [safran   safran  ]  sonar
├── [safran   safran  ]  datas
│   ├── [safran   safran  ]  alfresco
│   ├── [safran   safran  ]  cas
│   ├── [safran   safran  ]  delivery-manager
│   ├── [apache   apache  ]  dokuwiki
│   ├── [root     root    ]  gitlab
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  jira
│   ├── [safran   safran  ]  karaf
│   ├── [mysql    mysql   ]  mariadb
│   ├── [safran   safran  ]  nexus
│   ├── [apache   apache  ]  php
│   ├── [safran   safran  ]  referenceTool
│   ├── [safran   safran  ]  sonar
│   ├── [apache   apache  ]  spip
│   ├── [apache   apache  ]  ssl
│   ├── [apache   root    ]  ssl.dir
│   ├── [apache   root    ]  ssl.pag
│   ├── [safran   safran  ]  subversion
│   ├── [sympa    sympa   ]  sympa
│   └── [apache   apache  ]  testlink
├── [root     root    ]  deployment.xml
├── [safran   safran  ]  engines
│   ├── [safran   safran  ]  alfresco
│   ├── [safran   safran  ]  cas
│   ├── [apache   apache  ]  dokuwiki
│   ├── [safran   safran  ]  java
│   │   ├── [safran   safran  ]  jdk7
│   │   └── [safran   safran  ]  jdk8
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  jira
│   ├── [safran   safran  ]  jre
│   ├── [safran   safran  ]  jre8
│   ├── [safran   safran  ]  karaf
│   ├── [apache   apache  ]  limesurvey
│   ├── [apache   apache  ]  mantis
│   ├── [apache   apache  ]  mantis_ard
│   ├── [safran   safran  ]  nexus
│   ├── [safran   safran  ]  novaforge-user-guide
│   ├── [safran   safran  ]  novaforge-welcome-page
│   ├── [apache   apache  ]  phpBB3
│   ├── [safran   safran  ]  sonar
│   ├── [apache   apache  ]  spip
│   └── [apache   apache  ]  testlink
├── [safran   safran  ]  logs
│   ├── [safran   safran  ]  alfresco
│   ├── [safran   safran  ]  cas
│   ├── [safran   safran  ]  deployment
│   ├── [root     root    ]  gitlab
│   ├── [apache   apache  ]  httpd
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  jira
│   ├── [safran   safran  ]  karaf
│   ├── [mysql    mysql   ]  mariadb
│   ├── [safran   safran  ]  nexus
│   ├── [safran   safran  ]  sonar
│   ├── [apache   apache  ]  spip_sites
│   ├── [root     root    ]  sympa
│   └── [apache   apache  ]  testlink
├── [safran   safran  ]  system
│   ├── [safran   safran  ]  crt
│   ├── [root     root    ]  gitlab -> /etc/gitlab
│   ├── [apache   apache  ]  httpd
│   ├── [mysql    mysql   ]  mariadb
│   ├── [apache   apache  ]  php
│   └── [sympa    sympa   ]  sympa
└── [safran   safran  ]  tmp
    ├── [safran   safran  ]  alfresco
    ├── [safran   safran  ]  cas
    ├── [safran   safran  ]  deployment
    ├── [safran   safran  ]  jenkins
    ├── [safran   safran  ]  karaf
    ├── [safran   safran  ]  nexus
    └── [safran   safran  ]  sonar
]]>
</programlisting>
		</sect4>
		<sect4>
			<title>Cas une forge distribuée</title>
			VM Portail :
<programlisting>
<![CDATA[
/datas/safran/
├── [safran   safran  ]  bin
│   ├── [safran   safran  ]  cas
│   ├── [safran   safran  ]  karaf
│   └── [safran   safran  ]  nexus
├── [safran   safran  ]  datas
│   ├── [safran   safran  ]  cas
│   ├── [safran   safran  ]  delivery-manager
│   ├── [apache   apache  ]  dokuwiki
│   ├── [safran   safran  ]  jacoco
│   ├── [safran   safran  ]  karaf
│   ├── [mysql    mysql   ]  mariadb
│   ├── [safran   safran  ]  nexus
│   ├── [apache   apache  ]  php
│   ├── [safran   safran  ]  referenceTool
│   ├── [apache   apache  ]  spip
│   ├── [apache   apache  ]  ssl
│   ├── [apache   root    ]  ssl.dir
│   ├── [apache   root    ]  ssl.pag
│   ├── [sympa    sympa   ]  sympa
│   └── [apache   apache  ]  testlink
├── [root     root    ]  deployment.xml
├── [safran   safran  ]  engines
│   ├── [safran   safran  ]  cas
│   ├── [apache   apache  ]  dokuwiki
│   ├── [safran   safran  ]  jre
│   ├── [safran   safran  ]  karaf
│   ├── [apache   apache  ]  limesurvey
│   ├── [apache   apache  ]  mantis
│   ├── [apache   apache  ]  mantis_ard
│   ├── [safran   safran  ]  nexus
│   ├── [safran   safran  ]  novaforge-user-guide
│   ├── [safran   safran  ]  novaforge-welcome-page
│   ├── [apache   apache  ]  phpBB3
│   ├── [apache   apache  ]  spip
│   └── [apache   apache  ]  testlink
├── [safran   safran  ]  logs
│   ├── [safran   safran  ]  cas
│   ├── [safran   safran  ]  deployment
│   ├── [apache   apache  ]  httpd
│   ├── [safran   safran  ]  karaf
│   ├── [mysql    mysql   ]  mariadb
│   ├── [safran   safran  ]  nexus
│   ├── [apache   apache  ]  spip_sites
│   ├── [root     root    ]  sympa
│   └── [apache   apache  ]  testlink
├── [safran   safran  ]  system
│   ├── [safran   safran  ]  crt
│   ├── [apache   apache  ]  httpd
│   ├── [mysql    mysql   ]  mariadb
│   ├── [apache   apache  ]  php
│   └── [sympa    sympa   ]  sympa
└── [safran   safran  ]  tmp
    ├── [safran   safran  ]  cas
    ├── [safran   safran  ]  deployment
    ├── [safran   safran  ]  karaf
    └── [safran   safran  ]  nexus

48 directories, 6 files
]]>
</programlisting>

VM GED:

<programlisting>
<![CDATA[
/datas/safran/
├── [safran   safran  ]  bin
│   ├── [safran   safran  ]  alfresco
│   └── [safran   safran  ]  karaf
├── [safran   safran  ]  datas
│   ├── [safran   safran  ]  alfresco
│   ├── [safran   safran  ]  karaf
│   └── [mysql    mysql   ]  mariadb
├── [safran   safran  ]  deployment.xml
├── [safran   safran  ]  engines
│   ├── [safran   safran  ]  alfresco
│   ├── [safran   safran  ]  jre
│   └── [safran   safran  ]  karaf
├── [safran   safran  ]  logs
│   ├── [safran   safran  ]  alfresco
│   ├── [safran   safran  ]  deployment
│   ├── [safran   safran  ]  karaf
│   └── [mysql    mysql   ]  mariadb
├── [safran   safran  ]  system
│   ├── [safran   safran  ]  crt
│   └── [mysql    mysql   ]  mariadb
└── [safran   safran  ]  tmp
    ├── [safran   safran  ]  alfresco
    ├── [safran   safran  ]  deployment
    └── [safran   safran  ]  karaf

21 directories, 3 files
]]>
</programlisting>

VM PIC:

<programlisting>
<![CDATA[
/datas/safran/
├── [safran   safran  ]  bin
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  karaf
│   └── [safran   safran  ]  sonar
├── [safran   safran  ]  datas
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  karaf
│   ├── [mysql    mysql   ]  mariadb
│   └── [safran   safran  ]  sonar
├── [safran   safran  ]  deployment.xml
├── [safran   safran  ]  engines
│   ├── [safran   safran  ]  java
│   │   ├── [safran   safran  ]  jdk7
│   │   └── [safran   safran  ]  jdk8
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  jre
│   ├── [safran   safran  ]  jre8
│   ├── [safran   safran  ]  karaf
│   └── [safran   safran  ]  sonar
├── [safran   safran  ]  logs
│   ├── [safran   safran  ]  deployment
│   ├── [safran   safran  ]  jenkins
│   ├── [safran   safran  ]  karaf
│   ├── [mysql    mysql   ]  mariadb
│   └── [safran   safran  ]  sonar
├── [safran   safran  ]  system
│   ├── [safran   safran  ]  crt
│   └── [mysql    mysql   ]  mariadb
└── [safran   safran  ]  tmp
    ├── [safran   safran  ]  deployment
    ├── [safran   safran  ]  jenkins
    ├── [safran   safran  ]  karaf
    └── [safran   safran  ]  sonar

25 directories, 4 files
]]>
</programlisting>

VM SVN:

<programlisting>
<![CDATA[
/datas/safran/
├── [safran   safran  ]  bin
│   ├── [safran   safran  ]  gitlab
│   └── [safran   safran  ]  karaf
├── [safran   safran  ]  datas
│   ├── [root     root    ]  gitlab
│   ├── [safran   safran  ]  karaf
│   ├── [mysql    mysql   ]  mariadb
│   └── [safran   safran  ]  subversion
├── [safran   safran  ]  deployment.xml
├── [safran   safran  ]  engines
│   ├── [safran   safran  ]  jre
│   └── [safran   safran  ]  karaf
├── [safran   safran  ]  logs
│   ├── [safran   safran  ]  deployment
│   ├── [root     root    ]  gitlab
│   ├── [apache   apache  ]  httpd
│   ├── [safran   safran  ]  karaf
│   └── [mysql    mysql   ]  mariadb
├── [safran   safran  ]  system
│   ├── [safran   safran  ]  crt
│   ├── [root     root    ]  gitlab -> /etc/gitlab
│   ├── [apache   apache  ]  httpd
│   ├── [mysql    mysql   ]  mariadb
│   └── [safran   safran  ]  sshd
└── [safran   safran  ]  tmp
    ├── [safran   safran  ]  deployment
    └── [safran   safran  ]  karaf

24 directories, 3 files
]]></programlisting>
    </sect4>
	<sect2>
		<title>Procédures centrales</title>
	</sect2>
	<sect3>
		<title>Arrêt/Relance</title>
		<para>
			L'arrêt et la relance des services se fait en utilisant le gestionnaire de services systemd par l'intermédiaire de la commande systemctl.
			Il existe un service pour chacun des démons non distribués liés à Novaforge, à savoir la facade Web, le moteur de stockage, le SSO, le gestionnaire de mailing-lists et le gestionnaire de dépots Maven.
		</para>

		<para>
			Certaines applications peuvent être déportées sur d'autres machines. Il existe un service pour chacune de ces applications. Un service nommé novaforge permet d'encapsuler tous les services lié à Novaforge et simplifie l'arrêt et le redémarrage de la forge
		</para>

		<para>Relancer les démons :</para>
		<programlisting language="shell"># systemctl start novaforge</programlisting>

		<para>Arreter les démons :</para>
		<programlisting language="shell">
# systemctl stop httpd
# systemctl stop cas
# systemctl stop sympa
# systemctl stop nexus
# systemctl stop alfresco
# systemctl stop jenkins
# systemctl stop sonar
# systemctl stop gitlab
# systemctl stop mysql</programlisting>

		<para>
			<inlinemediaobject>
				<imageobject>
					<imagedata fileref="02-dialog-warning.png" width="27px" />
				</imageobject>
			</inlinemediaobject>
			Attention, les commandes doivent être exécutées  sur la machine virtuelle
			hébergant l'application.
		</para>

	</sect3>
</chapter>
