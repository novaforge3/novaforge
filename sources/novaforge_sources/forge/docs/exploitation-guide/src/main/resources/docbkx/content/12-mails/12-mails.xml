<?xml version="1.0" encoding="UTF-8"?>
<!--
 * Copyright (c) 2011-2015, BULL SAS, NovaForge Version 3 and above.
 *
 * This file is free software: you may redistribute and/or 
 * modify it under the terms of the GNU Affero General Public License
 * as published by the Free Software Foundation, version 3 of the License.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty
 * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Affero General Public License for more details.
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see http://www.gnu.org/licenses.
 *
 * Additional permission under GNU AGPL version 3 (AGPL-3.0) section 7
 *
 * If you modify this Program, or any covered work,
 * by linking or combining it with libraries listed
 * in COPYRIGHT file at the top-level directof of this
 * distribution (or a modified version of that libraries),
 * containing parts covered by the terms of licenses cited
 * in the COPYRIGHT file, the licensors of this Program
 * grant you additional permission to convey the resulting work.
-->
<chapter version="5.0" xml:lang="fr" xmlns="http://docbook.org/ns/docbook"
	xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:ns5="http://www.w3.org/2000/svg" xmlns:ns4="http://www.w3.org/1998/Math/MathML"
	xmlns:ns3="http://www.w3.org/1999/xhtml" xmlns:db="http://docbook.org/ns/docbook">
	
	<title>Mails</title>
	<sect2>
		<title>Configuration de l'adresse et du port d'écoute du Relais SMTP</title>

		<para>En cas de modification post-installation de l'adresse ou du port
			d'écoute du relais SMTP d'une forge , il est nécessaire d'intervenir
			dans les configurations de chaque outil envoyant des mails
			(excepté Sympa) ainsi que dans la configuration du Mail Transfert
			Agent SendMail.
		</para>

		<para>Par defaut, le port d'écoute d'un relais SMTP est le 25.</para>

		<para>Avant de modifier les paramètres du Relais SMTP, stopper la
			forge et tous ses services.
		</para>

		<sect3>
			<title>Modification dans le MTA SendMail</title>
			<para>Editer le fichier de configuration de sendmail sendmail.mc
			</para>

			<programlisting language="shell"># vi /etc/mail/sendmail.mc</programlisting>

			<para>Modifier le paramètre SMART_HOST et ajouter RELAY_MAILER_ARGS
				si le port du relai est différent du port d'écoute par défaut.
			</para>

			<programlisting language="xml">define(`SMART_HOST',`NOM_SERVEUR')dnl
define(`RELAY_MAILER_ARGS', `TCP $h 27')dnl</programlisting>

			<para>Recompiler le fichier de configuration sendmail et relancer le service sendmail</para>

			<programlisting language="shell"># /etc/mail/make
# systemctl restart sendmail</programlisting>

		</sect3>

		<sect3>
			<title>Modification dans Karaf</title>
			<para>Editer les fichiers de configuration suivant et modifier l'host
				et le port.
			</para>

			<programlisting language="shell"># vi $NOVA_HOME/engines/karaf/system/org/novaforge/forge/modules/
   novaforge-commons-technical-impl/$TAG/
   novaforge-commons-technical-impl-$TAG-mail.cfg</programlisting>
	
			 <para>
       			<inlinemediaobject>
            		<imageobject>
              			<imagedata fileref="02-dialog-warning.png" width="27px"/>
           			</imageobject>
       			</inlinemediaobject>
      			Attention, remplacer $TAG par la version de NovaForge ! </para> 

			<programlisting language="xml">host=NOM_SERVEUR
port=27</programlisting>

			<programlisting language="shell"># vi $NOVA_HOME/engines/karaf/nf-conf/forge/commons.mail.cfg</programlisting>

			<programlisting language="xml">host=NOM_SERVEUR
port=27</programlisting>
		</sect3>

		<sect3>
			<title>Modification dans Alfresco</title>
			<para>Editer le fichier de configuration suivant et modifier l'host
				et le port.
			</para>

			<programlisting language="shell"># vi $NOVA_HOME/engines/alfresco/shared/
   classes/alfresco-global.properties</programlisting>

			<programlisting language="xml">mail.host=NOM_SERVEUR
mail.port=27</programlisting>
		</sect3>

		<sect3>
			<title>Modification dans Jenkins</title>
			<para>Editer le fichier de configuration suivant et modifier l'host
				et le port.
			</para>

			<programlisting language="shell"># vi $NOVA_HOME/datas/jenkins/hudson.tasks.Mailer.xml</programlisting>

			<programlisting language="xml"><![CDATA[<smtpHost>NOM_SERVEUR</smtpHost>
<smtpPort>27</smtpPort>
]]></programlisting>
		</sect3>

		<sect3>
			<title>Modification dans Limesurvey</title>
			<para>Editer le fichier de configuration suivant et modifier l'host
				et le port.
			</para>

			<programlisting language="shell"># vi $NOVA_HOME/engines/limesurvey/config-defaults.php</programlisting>

			<programlisting language="xml">emailsmtphost=NOM_SERVEUR:27</programlisting>
		</sect3>

		<sect3>
			<title>Modification dans Mantis</title>
			<para>Editer les fichiers de configuration suivant et modifier l'host
				et le port.
			</para>

			<programlisting language="shell"># vi $NOVA_HOME/engines/mantis/config/config_inc.php</programlisting>

			<programlisting language="xml">$g_smtp_host=NOM_SERVEUR;
$g_smtp_port = 27;</programlisting>
		</sect3>

		<sect3>
			<title>Modification dans Nexus</title>
			<para>Editer les fichiers de configuration suivant et modifier l'host
				et le port.
			</para>

			<programlisting language="shell"># vi $NOVA_HOME/datas/nexus/conf/nexus.xml </programlisting>

			<programlisting language="xml"><![CDATA[<hostname>NOM_SERVEUR</hostname>
<port>27</port>
]]></programlisting>
		</sect3>

		<sect3>
			<title>Modification dans PhpBB</title>
			<para>Executer les requetes SQL suivantes :</para>

			<programlisting language="SQL"># mysql -uroot -proot phpbb -e
"UPDATE phpbb_config SET config_value='27'
WHERE config_name='smtp_port';"

# mysql -uroot -proot phpbb -e "UPDATE phpbb_config
SET config_value='NOM_SERVEUR'
WHERE config_name='smtp_host';"

# mysql -uroot -proot phpbb -e "SELECT *
FROM phpbb_config
WHERE config_name='smtp_port';"

# mysql -uroot -proot phpbb -e "SELECT *
FROM phpbb_config
WHERE config_name='smtp_host';"</programlisting>

		</sect3>

		<sect3>
			<title>Modification dans TestLink</title>
			<para>Editer les fichiers de configuration suivant et modifier l'host
				et le port.
			</para>

			<programlisting language="shell"># vi $NOVA_HOME/engines/testlink/config.inc.php</programlisting>

			<programlisting language="xml">$g_smtp_host =
'NOM_SERVEUR';
$g_smtp_port = 27;</programlisting>
		</sect3>
	</sect2>

</chapter>