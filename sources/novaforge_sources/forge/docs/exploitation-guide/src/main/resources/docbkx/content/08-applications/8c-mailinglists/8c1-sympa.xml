<?xml version="1.0" encoding="UTF-8"?>
<!--
 * Copyright (c) 2011-2015, BULL SAS, NovaForge Version 3 and above.
 *
 * This file is free software: you may redistribute and/or 
 * modify it under the terms of the GNU Affero General Public License
 * as published by the Free Software Foundation, version 3 of the License.
 *
 * This file is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty
 * of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
 * See the GNU Affero General Public License for more details.
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see http://www.gnu.org/licenses.
 *
 * Additional permission under GNU AGPL version 3 (AGPL-3.0) section 7
 *
 * If you modify this Program, or any covered work,
 * by linking or combining it with libraries listed
 * in COPYRIGHT file at the top-level directof of this
 * distribution (or a modified version of that libraries),
 * containing parts covered by the terms of licenses cited
 * in the COPYRIGHT file, the licensors of this Program
 * grant you additional permission to convey the resulting work.
-->
<section version="5.0" xml:lang="fr" xmlns="http://docbook.org/ns/docbook"
         xmlns:xlink="http://www.w3.org/1999/xlink"
         xmlns:xi="http://www.w3.org/2001/XInclude"
         xmlns:ns5="http://www.w3.org/2000/svg"
         xmlns:ns4="http://www.w3.org/1998/Math/MathML"
         xmlns:ns3="http://www.w3.org/1999/xhtml"
         xmlns:db="http://docbook.org/ns/docbook">

  <title>Gestionnaire de listes de diffusion</title>
   <sect2>
     <title>Sympa</title>
  <sect3>
     <title>Description</title>
     <para>Sympa est installé en version 6.2.14. Il est composé d'une application web avec une API SOAP et de processus système permettant de gérer les listes, les tâches basiques associées au cycle de vie d'une liste, l'envoi et l'archivage de mails.
     L'application web est desservie par Apache grâce au module mod_fastcgi permettant d'interpréter le script fast CGI. Le répertoire de configuration de Sympa se trouve dans : 
  </para>
  <programlisting language="shell"># $NOVA_HOME/system/sympa/</programlisting></sect3>
  <sect3>
      <title>Arrêt/Relance</title>
      <para>
      Un service permet d'arrêter/relancer tous les démons liés à sympa</para>
      <programlisting language="shell"># systemctl start sympa
# systemctl stop sympa</programlisting>
      <para>Au démarrage, on trouve les démons suivants :</para>
       <itemizedlist>
		<listitem>
        <para><programlisting language="shell"># /usr/sbin/sympa_msg.pl</programlisting></para>
        </listitem>
        <listitem>
        <para><programlisting language="shell"># /usr/sbin/bulk.pl</programlisting></para>
        </listitem>
        <listitem>
        <para><programlisting language="shell"># /usr/sbin/archived.pl</programlisting></para>
        </listitem>
        <listitem>
        <para><programlisting language="shell"># /usr/sbin/bounced.pl</programlisting></para>
        </listitem>
        <listitem>
        <para><programlisting language="shell"># /usr/sbin/task_manager.pl</programlisting></para>
        </listitem>
       </itemizedlist>
 </sect3>
 <sect3>
   <title>Configuration</title>
   <para>Le fichier de configuration de Sympa est :</para>
    <itemizedlist>
        <listitem>
        <para><programlisting language="shell">#  $NOVA_HOME/system/sympa/sympa.conf</programlisting></para>
        </listitem>      
    </itemizedlist>    
 </sect3>
 <sect3>
   <title>Stockage des données</title>
   <para>Les données de Sympa se trouve dans le répertoire :</para>
      <programlisting language="shell"># $NOVA_HOME/datas/sympa</programlisting>
 </sect3>
 <sect3>
   <title>Configuration des logs</title>
   <para>Sympa utilise le service SYSLOG pour la gestion des logs.
   Ce service est configuré pour écrire dans le fichier suivant : </para>
   <programlisting language="shell"># $NOVA_HOME/logs/sympa/sympa.log</programlisting>
   <para>
       <inlinemediaobject>
            <imageobject>
              <imagedata fileref="02-dialog-warning.png" width="27px"/>
            </imageobject>
       </inlinemediaobject>
      Attention, le service syslog doit être démarré : </para>   
      
      <programlisting language="shell"> # systemctl start syslog</programlisting>
 </sect3>
 <sect3>
  <title>Configuration de Sendmail et des alias</title>
  <para>Les alias du serveur de messagerie permettent de lancer des programmes lors de la réception d'un mail. 
	Ceci permet l'envoi des mails à tous les abonnés d'une liste lors de la réception d'un mail destiné à une liste de diffusion. 
	Sympa est configuré de telle manière que les programmes <emphasis>queue</emphasis>,  <emphasis>bouncequeue</emphasis> et  <emphasis>familyqueue</emphasis> seront appelés via le shell sécurisé de sendmail.
	Pour permettre leur lancement, il faut : </para>

    <itemizedlist>
        <listitem>
      <para>s'assurer que le <emphasis>suid</emphasis> soit présent pour ces programmes : 
      
<programlisting language="shell">
# ll $NOVA_HOME/system/sympa/bin/queue
-rwsr-xr-x. 1 sympa sympa 24318 Mar 25  2016 queue


# ll $NOVA_HOME/system/sympa/bin/bouncequeue
-rwsr-xr-x. 1 sympa sympa 22723 Mar 25  2016 bouncequeue
    
#  ll $NOVA_HOME/system/sympa/bin/familyqueue
-rwsr-xr-x. 1 sympa sympa 24985 Mar 25  2016 familyqueue

</programlisting>

   <para>Dans le cas où ce n'est pas fait, il faut taper les commandes suivantes : </para>
   <programlisting language="shell">

# chmod +s $NOVA_HOME/system/sympa/bin/queue
# chmod +s $NOVA_HOME/system/sympa/bin/bouncequeue
# chmod +s $NOVA_HOME/system/sympa/bin/familyqueue
</programlisting>
   </para>
   </listitem>
   <listitem>
   <para>S'assurer de la présence des liens symboliques dans le répertoire <emphasis>/etc/smrsh</emphasis>  : </para>
   <programlisting language="shell">#  ll /etc/smrsh/queue
lrwxrwxrwx. 1 sympa sympa 36 Sep 26 10:22 /etc/smrsh/queue -> 
$NOVA_HOME/system/sympa/bin/queue

# ll /etc/smrsh/bouncequeue
lrwxrwxrwx. 1 sympa sympa 42 Sep 26 10:22 /etc/smrsh/bouncequeue -> 
$NOVA_HOME/system/sympa/bin/bouncequeue
    
# ll /etc/smrsh/familyqueue
lrwxrwxrwx. 1 sympa sympa 42 Sep 26 10:22 /etc/smrsh/familyqueue -> 
$NOVA_HOME/system/sympa/bin/familyqueue

</programlisting>

   <para>Dans le cas où ce n'est pas fait, il faut taper les commandes suivantes : </para>
<programlisting language="shell"># ln -s $NOVA_HOME/system/sympa/bin/queue /etc/smrsh/queue
# ln -s $NOVA_HOME/system/sympa/bin/bouncequeue /etc/smrsh/bouncequeue
# ln -s $NOVA_HOME/system/sympa/bin/familyqueue /etc/smrsh/familyqueue
</programlisting>

   </listitem>
   <listitem>
   <para>S'assurer que les droits de lecture et d'éxecution sont permis pour les autres utilisateurs afin que le user sendmail puisse accéder au fichier :</para>
   
   <programlisting language="shell">#  ll /datas/safran/system/ | grep sympa
drwxr-xr-x. 2 sympa  sympa  4096 Jul 22 17:43 sympa
</programlisting>

   <para>Dans le cas où ce n'est pas fait, il faut taper l commande suivante : </para>
   
   <programlisting language="shell"># chmod -R 755 $NOVA_HOME/system/sympa</programlisting>
  </listitem>
  </itemizedlist>
 </sect3>
 <sect3>
   <title>Configuration du sendmail</title>
   <emphasis>Utilisation d'un relais SMTP</emphasis>
   <para>L'hôte hébergeant sympa et le sendmail doit être déclaré dans le DNS comme serveur de messagerie avec le nom de domaine correspondant au robot sympa.
Afin que Sympa puisse recevoir et envoyer des mails vers un relais SMTP, il faut configurer la variable SMART_HOST dans le fichier /etc/mail/sendmail.mc puis regénérer le fichier /etc/mail/sendmail.cd en effectuant la commande
suivante : 
   <programlisting language="shell"># /etc/mail/make</programlisting>
   Et redémarrer sendmail :
    <programlisting language="shell"># systemctl restart sendmail</programlisting>  
   </para>
 </sect3>
   <sect3>
    <title>Description des fichiers de configuration</title>
  <emphasis>plugins.sympa.cfg</emphasis>
  <itemizedlist>
<listitem>clientAdmin : Login accès à sympa dans la forge </listitem>
<listitem>clientPwd : Password associé au login ci-dessus </listitem>
<listitem>listMaster : Email du super-administrateur Sympa. Valeur définie dans sympa.conf</listitem>
<listitem>endpoint : Endpoint SOAP pour Sympa </listitem>
<listitem>adminAccess : URL d'accès de l'administration de Sympa dans la forge</listitem>
<listitem>defaultToolUrl : URL d'accès de Sympa dans la forge</listitem>
</itemizedlist>
  </sect3>
    </sect2>
</section>
